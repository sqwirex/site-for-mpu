name: üöÄ Deploy Bot

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}          # e.g. 158.160.117.222
        username: ${{ secrets.VPS_USER }}      # –≤–∞—à –ª–æ–≥–∏–Ω –Ω–∞ VPS
        key: ${{ secrets.VPS_SSH_KEY }}        # –ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH-–∫–ª—é—á
        port: 22                               # –æ–±—ã—á–Ω–æ 22
        script: |
          set -e
          cd ~/site-for-mpu

          # –°–±—Ä–∞—Å—ã–≤–∞–µ–º—Å—è –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –∫–æ–º–º–∏—Ç—É main
          git fetch origin main
          git reset --hard origin/main

          # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          if docker ps -q --filter name=wordly-bot >/dev/null; then
            docker rm -f wordly-bot
          fi

          # –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
          docker build -t wordly-bot .

          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –º–æ–Ω—Ç–∏—Ä—É—è –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –≤ /app
          docker run -d \
            --name wordly-bot \
            --restart unless-stopped \
            --env-file /app/telegram-wordly-bot/.env \
            -v ~/site-for-mpu:/app \
            wordly-bot

          echo "‚úÖ Bot deployed successfully"

